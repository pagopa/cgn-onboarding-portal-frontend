# Get current unstaged files
unstagedFiles=`git diff --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' | sed 's| |\\ |g'`
unstagedCount=`echo "$unstagedFiles" | wc -l | sed 's/ //g'`
echo "Current modified files ($unstagedCount):"
echo "$unstagedFiles"

# Compile the project
echo "ğŸ”¨ compiling..."
yarn tsc:noEmit

CI=true yarn test || { echo "âŒ tests failed"; exit 1; }

# Check for dead code
echo "ğŸ§Ÿ checking for dead code..."
npx knip --exclude devDependencies || { echo "âŒ dead code detected"; exit 1; }


# Run lintier
echo "ğŸ§¹ running linter..."  
yarn lint-autofix
# Run prettifier
echo "ğŸ§¼ running prettier..."
yarn prettify

# If we have any modified files don't push
if [ -n "$(git status --porcelain)" ]; then
  # Collect all modified files
  updatedUnstagedFiles=`git diff --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' | sed 's| |\\ |g'`
  updatedStagedCount=`echo "$updatedUnstagedFiles" | wc -l | sed 's/ //g'`
  echo "Modified files after linting and prettifying ($updatedStagedCount):"
  echo "$updatedUnstagedFiles"

  # Did linter and prettier found some issues?
  newStageFilesCount=$((updatedStagedCount-unstagedCount))  
  if [ "$newStageFilesCount" -gt 0 ]; then
    echo "âŒ Some files were not well formed: $newStageFilesCount"
    exit 1
  else
    echo "âœ… All files are clean!"
  fi
fi

echo "ğŸš€ pushing..."
echo "âœ¨ Done."